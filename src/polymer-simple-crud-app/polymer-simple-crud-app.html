<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/iron-form/iron-form.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">

<link rel="import" href="elements/psca-create.html">
<link rel="import" href="elements/psca-read.html">
<link rel="import" href="elements/psca-update.html">
<link rel="import" href="elements/psca-delete.html">

<dom-module id="polymer-simple-crud-app">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <psca-create 
      config="[[ config ]]" 
      url="[[ urls.create ]]" 
      quotes="{{ quotes }}">
    </psca-create>
    
    <psca-read 
      url="[[ urls.read ]]" 
      quotes="{{ quotes }}"
      edit-mode="{{ editMode }}"
      delete-mode="{{ deleteMode }}">
    </psca-read>

    <psca-update 
      config="[[ config ]]" 
      url="[[ urls.update ]]" 
      quotes="{{ quotes }}"
      edit-mode="{{ editMode }}">
    </psca-update>

    <psca-delete 
      url="[[ urls.delete ]]" 
      quotes="{{ quotes }}"
      delete-mode="{{ deleteMode }}">
    </psca-delete>
    
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class PolymerSimpleCrudApp extends Polymer.Element {
      static get is() { return 'polymer-simple-crud-app'; }
      static get properties() {
        return {
          config: Object,
          urls  : Object,
          quotes: Array,
          // Current item selector information
          editMode: Object,
          deleteMode: Object
        }
      }
      
      constructor () {
        super()

        // NowDB API Configuration
        // http://nowdb.net

        const self = this

        this.loadAPIConfig('src/polymer-simple-crud-app/data/config.json', function(response) {
          const apiBaseUrl = 'http://io.nowdb.net/v2'
          const apiConfig  = JSON.parse(response)
          
          self.set('config', apiConfig)

          const buildUrl = function (action) {
            return apiBaseUrl + '/' + action + '/token/' + apiConfig.token + '/project/' + apiConfig.project + '/collection/' + apiConfig.collection + '/appid/' + apiConfig.appid
          }
  
          // Set CRUD Urls
          self.set('urls', {
            'create': apiBaseUrl + '/insert',
            'read'  : buildUrl('select_all'),
            'update': apiBaseUrl + '/update_id',
            'delete': buildUrl('remove_id') + '/id/'
          })
        })
      }

      // Load from data/config.json
      loadAPIConfig(filepath, callback) {
        const xobj = new XMLHttpRequest()
        xobj.overrideMimeType("application/json")
        xobj.open('GET', filepath, true)
        xobj.onreadystatechange = function () {
          if (xobj.readyState === 4 && xobj.status === 200) {
            callback(xobj.responseText)
          }
        }
        xobj.send(null)
      }
    }

    window.customElements.define(PolymerSimpleCrudApp.is, PolymerSimpleCrudApp);
  </script>
</dom-module>
